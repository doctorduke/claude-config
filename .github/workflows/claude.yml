name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    env:
      GITHUB_TOKEN: ${{ secrets.PAT_GITHUB }}

    steps:
      - name: Determine Issue/PR Number
        id: issue
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" || "${{ github.event_name }}" == "pull_request_review" ]]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=" >> $GITHUB_OUTPUT
          fi

      - name: Post initial comment with job link
        if: steps.issue.outputs.number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const comment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue.outputs.number }},
              body: `ü§ñ Claude is processing your request...\n\n[View workflow run](${runUrl})`
            });
            console.log(`Posted initial comment with ID: ${comment.data.id}`);
            core.setOutput('comment_id', comment.data.id);

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.event.pull_request && github.event.pull_request.head.ref || github.ref }}

      - name: Configure Git
        run: |
          git config --global user.email "claude-bot@anthropic.com"
          git config --global user.name "Claude Code Bot"

      - name: Setup Claude Response Handler
        run: |
          # Create helper directory
          mkdir -p /tmp/claude

          # Create the response posting script
          cat > /tmp/claude/post-response.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          ISSUE_NUMBER=$1
          OUTPUT_FILE=$2

          echo "Checking for Claude response files..."

          # First priority: Check if Claude created the expected response file
          if [ -f /tmp/claude_response.md ]; then
            echo "Found /tmp/claude_response.md - posting to PR/issue"
            gh issue comment $ISSUE_NUMBER --body-file /tmp/claude_response.md
            echo "SUCCESS: Posted Claude's response"
            exit 0
          fi

          # Second priority: Check if Claude created a plan file
          if [ -f /tmp/plan.md ]; then
            echo "Found /tmp/plan.md - posting to PR/issue"
            gh issue comment $ISSUE_NUMBER --body-file /tmp/plan.md
            echo "SUCCESS: Posted Claude's plan"
            exit 0
          fi

          # Third priority: Check if Claude created a response.md file
          if [ -f /tmp/response.md ]; then
            echo "Found /tmp/response.md - posting to PR/issue"
            gh issue comment $ISSUE_NUMBER --body-file /tmp/response.md
            echo "SUCCESS: Posted Claude's response"
            exit 0
          fi

          # Fallback: Extract Claude's text response from the output
          echo "No response files found. Extracting Claude's text response..."

          # Try to extract the result from the JSON output
          if [ -f "$OUTPUT_FILE" ]; then
            CLAUDE_TEXT=$(jq -r '.result // empty' "$OUTPUT_FILE" 2>/dev/null || echo "")

            if [ -n "$CLAUDE_TEXT" ]; then
              echo "## ü§ñ Claude Code Bot Response" > /tmp/fallback.md
              echo "" >> /tmp/fallback.md
              echo "$CLAUDE_TEXT" >> /tmp/fallback.md
              echo "" >> /tmp/fallback.md
              echo "---" >> /tmp/fallback.md
              echo "*ü§ñ Claude Code Bot ‚Ä¢ [View workflow](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)*" >> /tmp/fallback.md

              gh issue comment $ISSUE_NUMBER --body-file /tmp/fallback.md
              echo "WARNING: Posted fallback response (Claude didn't create expected files)"
              exit 0
            fi
          fi

          # Last resort: Post an error message
          echo "## ü§ñ Claude Code Bot - Error" > /tmp/error.md
          echo "" >> /tmp/error.md
          echo "I encountered an error processing your request. Claude did not generate a response file." >> /tmp/error.md
          echo "" >> /tmp/error.md
          echo "Please check the [workflow logs](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID) for details." >> /tmp/error.md
          echo "" >> /tmp/error.md
          echo "---" >> /tmp/error.md
          echo "*ü§ñ Claude Code Bot*" >> /tmp/error.md

          gh issue comment $ISSUE_NUMBER --body-file /tmp/error.md
          echo "ERROR: Posted error message (no response from Claude)"
          exit 1
          SCRIPT

          chmod +x /tmp/claude/post-response.sh

      - name: Gather conversation context
        id: context
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            let conversationHistory = "";
            let issueNumber = ${{ steps.issue.outputs.number }};
            let isPullRequest = false;

            if (issueNumber) {
              try {
                // Check if this is actually a PR
                try {
                  const pr = await github.rest.pulls.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: issueNumber
                  });
                  if (pr.data) {
                    isPullRequest = true;
                    conversationHistory += `## Pull Request #${issueNumber}: ${pr.data.title}\n\n`;
                    conversationHistory += `**Author:** ${pr.data.user.login}\n`;
                    conversationHistory += `**Branch:** ${pr.data.head.ref} ‚Üí ${pr.data.base.ref}\n`;
                    conversationHistory += `**State:** ${pr.data.state} | **Mergeable:** ${pr.data.mergeable}\n`;
                    conversationHistory += `**Body:**\n${pr.data.body || 'No description'}\n\n`;

                    // Get PR diff for context
                    conversationHistory += `### Files Changed:\n`;
                    const files = await github.rest.pulls.listFiles({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: issueNumber
                    });
                    files.data.forEach(file => {
                      conversationHistory += `- ${file.filename} (+${file.additions} -${file.deletions})\n`;
                    });
                    conversationHistory += `\n`;
                  }
                } catch (e) {
                  // Not a PR, treat as issue
                  const issue = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber
                  });
                  conversationHistory += `## Issue #${issueNumber}: ${issue.data.title}\n\n`;
                  conversationHistory += `**Author:** ${issue.data.user.login}\n`;
                  conversationHistory += `**Body:**\n${issue.data.body || 'No description'}\n\n`;
                }

                // Get all comments
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });

                if (comments.data.length > 0) {
                  conversationHistory += "## Previous Comments:\n\n";
                  comments.data.forEach(comment => {
                    conversationHistory += `**${comment.user.login}** (${new Date(comment.created_at).toLocaleString()}):\n`;
                    conversationHistory += `${comment.body}\n\n---\n\n`;
                  });
                }

                // For PRs, also get PR review comments
                if (isPullRequest) {
                  const prComments = await github.rest.pulls.listReviewComments({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: issueNumber
                  });

                  if (prComments.data.length > 0) {
                    conversationHistory += "## Code Review Comments:\n\n";
                    prComments.data.forEach(comment => {
                      conversationHistory += `**${comment.user.login}** on ${comment.path}:\n`;
                      conversationHistory += `${comment.body}\n\n`;
                    });
                  }
                }
              } catch (error) {
                console.log("Error gathering context:", error);
              }
            }

            // Save to file
            const fs = require('fs');
            fs.writeFileSync('/tmp/conversation.txt', conversationHistory);
            console.log("Conversation context saved to /tmp/conversation.txt");

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_GITHUB }}
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.PAT_GITHUB }}
          prompt: |
            You are Claude Code Bot, an AI assistant helping with GitHub issues and pull requests.

            ## Context
            First, read the conversation context to understand what's being discussed:
            ```bash
            cat /tmp/conversation.txt
            ```

            ## Current Request
            """
            ${{ github.event_name == 'issue_comment' && github.event.comment.body || '' }}
            ${{ github.event_name == 'pull_request_review_comment' && github.event.comment.body || '' }}
            ${{ github.event_name == 'pull_request_review' && github.event.review.body || '' }}
            ${{ github.event_name == 'issues' && github.event.issue.body || '' }}
            """

            ## CRITICAL INSTRUCTION
            You MUST create a response file at `/tmp/claude_response.md` using the Write tool.
            This is NOT optional. The workflow will fail if you don't create this file.

            Your response file MUST include:
            1. A header: ## ü§ñ Claude Code Bot Response
            2. Your complete analysis/response to the user's request
            3. A footer with signature

            Example structure for /tmp/claude_response.md:
            ```
            ## ü§ñ Claude Code Bot Response

            [Your detailed response here - analysis, code, explanations, etc.]

            ---
            *ü§ñ Claude Code Bot ‚Ä¢ Powered by [Claude 3.5 Sonnet](https://anthropic.com) ‚Ä¢ [View workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            ```

            ## Instructions
            1. Analyze the request thoroughly
            2. If it's a PR, you can view changes with: gh pr diff ${{ steps.issue.outputs.number }}
            3. Write your COMPLETE response to /tmp/claude_response.md
            4. Do NOT attempt to post comments yourself - just create the file
            5. Focus on being helpful and providing value to the user

            Remember: You MUST use the Write tool to create /tmp/claude_response.md
          claude_args: "--model claude-3-5-sonnet-20241022 --max-turns 25 --allowed-tools 'Bash(cat:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git:*),Read,Edit,Write,MultiEdit,Glob,Grep'"

      - name: Post Claude Response
        if: always()
        run: |
          echo "Attempting to post Claude's response..."

          # The output file from Claude action
          OUTPUT_FILE="/home/runner/work/_temp/claude-execution-output.json"

          # Call our helper script
          /tmp/claude/post-response.sh ${{ steps.issue.outputs.number }} "$OUTPUT_FILE"

          # Store the exit code
          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Successfully posted Claude's response"
          else
            echo "‚ùå Failed to post Claude's response"
            exit 1
          fi

      - name: Verify Comment Posted
        if: always() && steps.issue.outputs.number != ''
        run: |
          # Wait for GitHub API to propagate the comment
          sleep 5

          # Get the last few comments to verify
          RECENT_COMMENTS=$(gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/comments --jq '.[].body' | tail -5)

          if echo "$RECENT_COMMENTS" | grep -q "Claude Code Bot"; then
            echo "‚úÖ Verified: Claude Code Bot comment was posted"
          else
            echo "‚ö†Ô∏è  Warning: Could not verify Claude Code Bot comment"
            echo "Recent comments:"
            echo "$RECENT_COMMENTS"
          fi