name: AI Agent Matrix

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# Rate limiting: Only one run per issue/PR at a time
concurrency:
  group: ai-agents-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

env:
  # Control which agents are enabled
  ENABLE_CLAUDE: 'true'
  ENABLE_CODEX: 'false'    # Disabled until ready
  ENABLE_GEMINI: 'false'   # Disabled until ready
  ENABLE_CODERABBIT: 'false'  # Disabled until ready
  ENABLE_CURSOR: 'false'   # Disabled - IDE only, not bot

jobs:
  dispatch:
    runs-on: ubuntu-latest
    outputs:
      claude: ${{ steps.check.outputs.claude }}
      codex: ${{ steps.check.outputs.codex }}
      gemini: ${{ steps.check.outputs.gemini }}
      coderabbit: ${{ steps.check.outputs.coderabbit }}
    steps:
      - name: Rate limit check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check comment frequency to prevent spam/abuse
          ISSUE_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          COMMENTER="${{ github.event.comment.user.login }}"

          # Get comments from the last 5 minutes
          FIVE_MINS_AGO=$(date -u -d '5 minutes ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -u -v-5M '+%Y-%m-%dT%H:%M:%SZ')

          # Count AI agent mentions by this user in recent comments
          RECENT_MENTIONS=$(gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" \
            --jq "[.[] | select(.user.login == \"${COMMENTER}\" and .created_at > \"${FIVE_MINS_AGO}\") | .body | select(test(\"@(claude|codex|gemini|coderabbit)\"))] | length")

          echo "Recent AI agent mentions by ${COMMENTER}: ${RECENT_MENTIONS}"

          # Allow up to 3 mentions in 5 minutes (configurable)
          MAX_MENTIONS=3
          if [ "${RECENT_MENTIONS}" -gt "${MAX_MENTIONS}" ]; then
            echo "⚠️  Rate limit exceeded: ${RECENT_MENTIONS} mentions in 5 minutes (max: ${MAX_MENTIONS})"
            echo "Please wait before making additional AI agent requests."
            exit 1
          fi

      - id: check
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # Check if agent is mentioned AND enabled
          if [[ "$COMMENT" == *"@claude"* ]] && [[ "${{ env.ENABLE_CLAUDE }}" == "true" ]]; then
            echo "claude=true" >> $GITHUB_OUTPUT
          else
            echo "claude=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$COMMENT" == *"@codex"* ]] && [[ "${{ env.ENABLE_CODEX }}" == "true" ]]; then
            echo "codex=true" >> $GITHUB_OUTPUT
          else
            echo "codex=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$COMMENT" == *"@gemini"* ]] && [[ "${{ env.ENABLE_GEMINI }}" == "true" ]]; then
            echo "gemini=true" >> $GITHUB_OUTPUT
          else
            echo "gemini=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$COMMENT" == *"@coderabbit"* ]] && [[ "${{ env.ENABLE_CODERABBIT }}" == "true" ]]; then
            echo "coderabbit=true" >> $GITHUB_OUTPUT
          else
            echo "coderabbit=false" >> $GITHUB_OUTPUT
          fi

  claude:
    needs: dispatch
    if: needs.dispatch.outputs.claude == 'true'
    uses: ./.github/workflows/claude.yml
    secrets: inherit

  codex:
    needs: dispatch
    if: needs.dispatch.outputs.codex == 'true'
    uses: ./.github/workflows/codex.yml
    secrets: inherit

  gemini:
    needs: dispatch
    if: needs.dispatch.outputs.gemini == 'true'
    uses: ./.github/workflows/gemini.yml
    secrets: inherit

  # These run in PARALLEL when multiple are mentioned
  # Each posts with their own identity:
  # "Claude Bot commented..."
  # "Codex Bot commented..."