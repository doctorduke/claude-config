name: AI Agent Matrix

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

env:
  # Control which agents are enabled
  ENABLE_CLAUDE: 'true'
  ENABLE_CODEX: 'false'    # Disabled until ready
  ENABLE_GEMINI: 'false'   # Disabled until ready
  ENABLE_CODERABBIT: 'false'  # Disabled until ready
  ENABLE_CURSOR: 'false'   # Disabled - IDE only, not bot

jobs:
  dispatch:
    runs-on: ubuntu-latest
    outputs:
      claude: ${{ steps.check.outputs.claude }}
      codex: ${{ steps.check.outputs.codex }}
      gemini: ${{ steps.check.outputs.gemini }}
      coderabbit: ${{ steps.check.outputs.coderabbit }}
    steps:
      - id: check
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # Check if agent is mentioned AND enabled
          if [[ "$COMMENT" == *"@claude"* ]] && [[ "${{ env.ENABLE_CLAUDE }}" == "true" ]]; then
            echo "claude=true" >> $GITHUB_OUTPUT
          else
            echo "claude=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$COMMENT" == *"@codex"* ]] && [[ "${{ env.ENABLE_CODEX }}" == "true" ]]; then
            echo "codex=true" >> $GITHUB_OUTPUT
          else
            echo "codex=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$COMMENT" == *"@gemini"* ]] && [[ "${{ env.ENABLE_GEMINI }}" == "true" ]]; then
            echo "gemini=true" >> $GITHUB_OUTPUT
          else
            echo "gemini=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$COMMENT" == *"@coderabbit"* ]] && [[ "${{ env.ENABLE_CODERABBIT }}" == "true" ]]; then
            echo "coderabbit=true" >> $GITHUB_OUTPUT
          else
            echo "coderabbit=false" >> $GITHUB_OUTPUT
          fi

  claude:
    needs: dispatch
    if: needs.dispatch.outputs.claude == 'true'
    uses: ./.github/workflows/claude.yml
    secrets: inherit

  codex:
    needs: dispatch
    if: needs.dispatch.outputs.codex == 'true'
    uses: ./.github/workflows/codex.yml
    secrets: inherit

  gemini:
    needs: dispatch
    if: needs.dispatch.outputs.gemini == 'true'
    uses: ./.github/workflows/gemini.yml
    secrets: inherit

  # These run in PARALLEL when multiple are mentioned
  # Each posts with their own identity:
  # "Claude Bot commented..."
  # "Codex Bot commented..."