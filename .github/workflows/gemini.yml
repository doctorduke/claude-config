name: Gemini Agent

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  gemini:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@gemini')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@gemini')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@gemini')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@gemini') || contains(github.event.issue.title, '@gemini')))
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    env:
      GITHUB_TOKEN: ${{ secrets.PAT_GITHUB }}

    steps:
      - name: Determine Issue/PR Number
        id: issue
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" || "${{ github.event_name }}" == "pull_request_review" ]]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=" >> $GITHUB_OUTPUT
          fi

      - name: Post initial comment with job link
        if: steps.issue.outputs.number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const comment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue.outputs.number }},
              body: `ðŸ¤– Gemini is processing your request...\n\n[View workflow run](${runUrl})`
            });
            console.log(`Posted initial comment with ID: ${comment.data.id}`);
            core.setOutput('comment_id', comment.data.id);

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.event.pull_request && github.event.pull_request.head.ref || github.ref }}

      - name: Configure Git
        run: |
          git config --global user.email "gemini-bot@google.com"
          git config --global user.name "Gemini Bot"

      - name: Setup Gemini Response Handler
        run: |
          # Create helper directory
          mkdir -p /tmp/gemini

          # Create the response posting script
          cat > /tmp/gemini/post-response.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          ISSUE_NUMBER=$1
          OUTPUT_FILE=$2

          echo "Checking for Gemini response files..."

          # First priority: Check if Gemini created the expected response file
          if [ -f /tmp/gemini_response.md ]; then
            echo "Found /tmp/gemini_response.md - posting to PR/issue"
            gh issue comment $ISSUE_NUMBER --body-file /tmp/gemini_response.md
            echo "SUCCESS: Posted Gemini's response"
            exit 0
          fi

          # Second priority: Check if Gemini created a plan file
          if [ -f /tmp/plan.md ]; then
            echo "Found /tmp/plan.md - posting to PR/issue"
            gh issue comment $ISSUE_NUMBER --body-file /tmp/plan.md
            echo "SUCCESS: Posted Gemini's plan"
            exit 0
          fi

          # Third priority: Check if Gemini created a response.md file
          if [ -f /tmp/response.md ]; then
            echo "Found /tmp/response.md - posting to PR/issue"
            gh issue comment $ISSUE_NUMBER --body-file /tmp/response.md
            echo "SUCCESS: Posted Gemini's response"
            exit 0
          fi

          # Fallback: Extract Gemini's text response from the output
          echo "No response files found. Extracting Gemini's text response..."

          # Try to extract the result from the JSON output
          if [ -f "$OUTPUT_FILE" ]; then
            GEMINI_TEXT=$(jq -r '.result // empty' "$OUTPUT_FILE" 2>/dev/null || echo "")

            if [ -n "$GEMINI_TEXT" ]; then
              echo "## ðŸ¤– Gemini Bot Response" > /tmp/fallback.md
              echo "" >> /tmp/fallback.md
              echo "$GEMINI_TEXT" >> /tmp/fallback.md
              echo "" >> /tmp/fallback.md
              echo "---" >> /tmp/fallback.md
              echo "*ðŸ¤– Gemini Bot â€¢ [View workflow](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)*" >> /tmp/fallback.md

              gh issue comment $ISSUE_NUMBER --body-file /tmp/fallback.md
              echo "WARNING: Posted fallback response (Gemini didn't create expected files)"
              exit 0
            fi
          fi

          # Last resort: Post an error message
          echo "## ðŸ¤– Gemini Bot - Error" > /tmp/error.md
          echo "" >> /tmp/error.md
          echo "I encountered an error processing your request. Gemini did not generate a response file." >> /tmp/error.md
          echo "" >> /tmp/error.md
          echo "Please check the [workflow logs](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID) for details." >> /tmp/error.md
          echo "" >> /tmp/error.md
          echo "---" >> /tmp/error.md
          echo "*ðŸ¤– Gemini Bot*" >> /tmp/error.md

          gh issue comment $ISSUE_NUMBER --body-file /tmp/error.md
          echo "ERROR: Posted error message (no response from Gemini)"
          exit 1
          SCRIPT

          chmod +x /tmp/gemini/post-response.sh

      - name: Gather conversation context
        id: context
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            let conversationHistory = "";
            let issueNumber = ${{ steps.issue.outputs.number }};
            let isPullRequest = false;

            if (issueNumber) {
              try {
                // Check if this is actually a PR
                try {
                  const pr = await github.rest.pulls.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: issueNumber
                  });
                  if (pr.data) {
                    isPullRequest = true;
                    conversationHistory += `## Pull Request #${issueNumber}: ${pr.data.title}\n\n`;
                    conversationHistory += `**Author:** ${pr.data.user.login}\n`;
                    conversationHistory += `**Branch:** ${pr.data.head.ref} â†’ ${pr.data.base.ref}\n`;
                    conversationHistory += `**State:** ${pr.data.state} | **Mergeable:** ${pr.data.mergeable}\n`;
                    conversationHistory += `**Body:**\n${pr.data.body || 'No description'}\n\n`;

                    // Get PR diff for context
                    conversationHistory += `### Files Changed:\n`;
                    const files = await github.rest.pulls.listFiles({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: issueNumber
                    });
                    files.data.forEach(file => {
                      conversationHistory += `- ${file.filename} (+${file.additions} -${file.deletions})\n`;
                    });
                    conversationHistory += `\n`;
                  }
                } catch (e) {
                  // Not a PR, treat as issue
                  const issue = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber
                  });
                  conversationHistory += `## Issue #${issueNumber}: ${issue.data.title}\n\n`;
                  conversationHistory += `**Author:** ${issue.data.user.login}\n`;
                  conversationHistory += `**Body:**\n${issue.data.body || 'No description'}\n\n`;
                }

                // Get all comments
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });

                if (comments.data.length > 0) {
                  conversationHistory += "## Previous Comments:\n\n";
                  comments.data.forEach(comment => {
                    conversationHistory += `**${comment.user.login}** (${new Date(comment.created_at).toLocaleString()}):\n`;
                    conversationHistory += `${comment.body}\n\n---\n\n`;
                  });
                }

                // For PRs, also get PR review comments
                if (isPullRequest) {
                  const prComments = await github.rest.pulls.listReviewComments({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: issueNumber
                  });

                  if (prComments.data.length > 0) {
                    conversationHistory += "## Code Review Comments:\n\n";
                    prComments.data.forEach(comment => {
                      conversationHistory += `**${comment.user.login}** on ${comment.path}:\n`;
                      conversationHistory += `${comment.body}\n\n`;
                    });
                  }
                }
              } catch (error) {
                console.log("Error gathering context:", error);
              }
            }

            // Save to file
            const fs = require('fs');
            fs.writeFileSync('/tmp/conversation.txt', conversationHistory);
            console.log("Conversation context saved to /tmp/conversation.txt");

      - name: Run Gemini Agent
        id: gemini
        run: |
          # Create a placeholder response for now
          # In a real implementation, this would call the Gemini API
          cat > /tmp/gemini_response.md << 'EOF'
          ## ðŸ¤– Gemini Bot Response

          Hello! I'm Gemini Bot, your AI assistant for code review and issue analysis.

          **Current Status:** Gemini integration is currently being set up. This is a placeholder response.

          **What I can help with:**
          - Code review and analysis
          - Issue triage and resolution
          - Documentation improvements
          - Technical discussions

          **Note:** Full Gemini API integration is pending. For now, I'm here to acknowledge your request and will be fully functional soon.

          ---
          *ðŸ¤– Gemini Bot â€¢ Powered by [Google Gemini](https://ai.google.dev) â€¢ [View workflow](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)*
          EOF

      - name: Post Gemini Response
        if: always()
        run: |
          echo "Attempting to post Gemini's response..."

          # The output file from Gemini action
          OUTPUT_FILE="/tmp/gemini_response.md"

          # Call our helper script
          /tmp/gemini/post-response.sh ${{ steps.issue.outputs.number }} "$OUTPUT_FILE"

          # Store the exit code
          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Successfully posted Gemini's response"
          else
            echo "âŒ Failed to post Gemini's response"
            exit 1
          fi

      - name: Verify Comment Posted
        if: always() && steps.issue.outputs.number != ''
        run: |
          # Wait for GitHub API to propagate the comment
          sleep 5

          # Get the last few comments to verify
          RECENT_COMMENTS=$(gh api repos/${{ github.repository }}/issues/${{ steps.issue.outputs.number }}/comments --jq '.[].body' | tail -5)

          if echo "$RECENT_COMMENTS" | grep -q "Gemini Bot"; then
            echo "âœ… Verified: Gemini Bot comment was posted"
          else
            echo "âš ï¸  Warning: Could not verify Gemini Bot comment"
            echo "Recent comments:"
            echo "$RECENT_COMMENTS"
          fi
