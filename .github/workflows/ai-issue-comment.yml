name: AI Issue Comment
description: Intelligent AI responses to issue comments

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to respond to'
        required: true
        type: number
      comment_id:
        description: 'Specific comment ID (optional)'
        required: false
        type: number

permissions:
  issues: write
  contents: read

env:
  AI_MODEL: claude-3-opus
  TRIGGER_PREFIX: '/agent'
  MAX_CONTEXT_COMMENTS: 10

jobs:
  respond:
    name: AI Issue Response
    runs-on: [self-hosted, linux, ai-agent]
    timeout-minutes: 3
    # Only run if comment contains trigger prefix or is manual dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/agent'))

    steps:
      # SECURITY: Mask secrets as first step to prevent credential exposure
      # OWASP A09:2021 - Security Logging and Monitoring Failures
      - name: Mask sensitive values
        uses: ./.github/actions/mask-secrets
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          ai_api_key: ${{ secrets.AI_API_KEY }}

      - name: Validate trigger
        id: validate
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ISSUE_NUM="${{ inputs.issue_number }}"
            COMMENT_ID="${{ inputs.comment_id || '' }}"
          else
            ISSUE_NUM="${{ github.event.issue.number }}"
            COMMENT_ID="${{ github.event.comment.id }}"
          fi

          # Validate issue number
          if [[ ! "$ISSUE_NUM" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid issue number: $ISSUE_NUM"
            exit 1
          fi

          echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT
          echo "::notice::Processing issue #$ISSUE_NUM (comment: $COMMENT_ID)"

      - name: Check for bot loop
        id: check_loop
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ steps.validate.outputs.issue_number }}
        run: |
          # Get last 5 comments
          RECENT_COMMENTS=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUM/comments \
            --jq '.[-5:] | .[].user.login' | grep -c "github-actions\[bot\]" || echo "0")

          if [[ "$RECENT_COMMENTS" -ge 3 ]]; then
            echo "::warning::Detected potential bot loop - too many bot comments"
            echo "loop_detected=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "loop_detected=false" >> $GITHUB_OUTPUT

      - name: Sparse checkout repository
        if: steps.check_loop.outputs.loop_detected == 'false'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            scripts/
            .github/
            src/
            tests/
          sparse-checkout-cone-mode: false

      - name: Setup AI agent environment
        if: steps.check_loop.outputs.loop_detected == 'false'
        id: setup
        run: |
          # Verify required tools
          command -v gh >/dev/null 2>&1 || { echo "::error::GitHub CLI not found"; exit 1; }
          command -v jq >/dev/null 2>&1 || { echo "::error::jq not found"; exit 1; }

          # Set up working directory
          mkdir -p /tmp/ai-agent-${{ github.run_id }}
          echo "work_dir=/tmp/ai-agent-${{ github.run_id }}" >> $GITHUB_OUTPUT

          # Configure GitHub CLI
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

          echo "::notice::Agent environment ready"

      - name: Extract issue context
        if: steps.check_loop.outputs.loop_detected == 'false'
        id: context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ steps.validate.outputs.issue_number }}
          WORK_DIR: ${{ steps.setup.outputs.work_dir }}
        run: |
          # Get full issue details
          gh issue view "$ISSUE_NUM" --json title,body,labels,comments \
            > "$WORK_DIR/issue-context.json"

          # Extract key information
          ISSUE_TITLE=$(jq -r '.title' "$WORK_DIR/issue-context.json")
          LABELS=$(jq -r '.labels[].name' "$WORK_DIR/issue-context.json" | paste -sd "," -)

          echo "title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "context_file=$WORK_DIR/issue-context.json" >> $GITHUB_OUTPUT

          echo "::notice::Extracted context for: $ISSUE_TITLE"

      - name: Extract user query
        if: steps.check_loop.outputs.loop_detected == 'false'
        id: query
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          WORK_DIR: ${{ steps.setup.outputs.work_dir }}
        run: |
          # Remove trigger prefix and extract query
          QUERY=$(echo "$COMMENT_BODY" | sed "s|$TRIGGER_PREFIX||g" | sed 's/^[[:space:]]*//g')

          if [[ -z "$QUERY" ]]; then
            QUERY="Please provide assistance with this issue."
          fi

          echo "$QUERY" > "$WORK_DIR/query.txt"
          echo "query_file=$WORK_DIR/query.txt" >> $GITHUB_OUTPUT

          echo "::notice::User query: ${QUERY:0:100}..."

      - name: Run AI agent script
        if: steps.check_loop.outputs.loop_detected == 'false'
        id: agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          ISSUE_NUM: ${{ steps.validate.outputs.issue_number }}
          CONTEXT_FILE: ${{ steps.context.outputs.context_file }}
          QUERY_FILE: ${{ steps.query.outputs.query_file }}
          WORK_DIR: ${{ steps.setup.outputs.work_dir }}
        run: |
          set -euo pipefail

          # Run AI agent script
          bash ./scripts/ai-agent.sh \
            --issue "$ISSUE_NUM" \
            --context "$CONTEXT_FILE" \
            --query "$QUERY_FILE" \
            --model "$AI_MODEL" \
            --output "$WORK_DIR/response.json" \
            --verbose

          # Validate JSON output
          if [[ -f "$WORK_DIR/response.json" ]]; then
            jq empty "$WORK_DIR/response.json" || {
              echo "::error::Invalid JSON output from AI agent"
              exit 1
            }
            echo "response_file=$WORK_DIR/response.json" >> $GITHUB_OUTPUT
            echo "::notice::AI agent response generated"
          else
            echo "::error::Response file not found"
            exit 1
          fi

      - name: Parse AI response
        if: steps.check_loop.outputs.loop_detected == 'false'
        id: parse
        env:
          RESPONSE_FILE: ${{ steps.agent.outputs.response_file }}
        run: |
          # Extract response body
          RESPONSE_BODY=$(jq -r '.response.body' "$RESPONSE_FILE")
          RESPONSE_TYPE=$(jq -r '.response.type // "comment"' "$RESPONSE_FILE")
          SUGGESTED_LABELS=$(jq -r '.response.suggested_labels // [] | join(",")' "$RESPONSE_FILE")

          echo "type=$RESPONSE_TYPE" >> $GITHUB_OUTPUT
          echo "suggested_labels=$SUGGESTED_LABELS" >> $GITHUB_OUTPUT

          # Save response body
          echo "$RESPONSE_BODY" > "$RESPONSE_FILE.body.md"
          echo "body_file=$RESPONSE_FILE.body.md" >> $GITHUB_OUTPUT

          echo "::notice::Response type: $RESPONSE_TYPE"

      - name: Post AI response
        if: steps.check_loop.outputs.loop_detected == 'false' && success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ steps.validate.outputs.issue_number }}
          BODY_FILE: ${{ steps.parse.outputs.body_file }}
        run: |
          # Add AI attribution footer
          cat >> "$BODY_FILE" << 'EOF'

---
*This response was generated by an AI agent. If you need further assistance, mention `/agent` in a comment.*
EOF

          # Post comment
          gh issue comment "$ISSUE_NUM" --body-file "$BODY_FILE"

          echo "::notice::Posted AI response to issue #$ISSUE_NUM"

      - name: Apply suggested labels
        if: steps.check_loop.outputs.loop_detected == 'false' && success() && steps.parse.outputs.suggested_labels != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ steps.validate.outputs.issue_number }}
          LABELS: ${{ steps.parse.outputs.suggested_labels }}
        run: |
          # Apply labels if any suggested
          IFS=',' read -ra LABEL_ARRAY <<< "$LABELS"
          for label in "${LABEL_ARRAY[@]}"; do
            gh issue edit "$ISSUE_NUM" --add-label "$label" || echo "::warning::Failed to add label: $label"
          done

          echo "::notice::Applied suggested labels: $LABELS"

      - name: Handle bot loop
        if: steps.check_loop.outputs.loop_detected == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ steps.validate.outputs.issue_number }}
        run: |
          gh issue comment "$ISSUE_NUM" --body "⚠️ **AI Agent Loop Detected**

          The AI agent has been temporarily disabled for this issue to prevent excessive automated comments.

          A human maintainer will review this issue shortly. Thank you for your patience!"

          echo "::warning::Bot loop detected and mitigated for issue #$ISSUE_NUM"

      - name: Handle agent failure
        if: steps.check_loop.outputs.loop_detected == 'false' && failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUM: ${{ steps.validate.outputs.issue_number }}
        run: |
          gh issue comment "$ISSUE_NUM" --body "⚠️ **AI Agent Error**

          The AI agent encountered an error while processing your request.

          - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - You can retry by commenting \`/agent\` again

          A maintainer has been notified and will assist shortly."

          echo "::error::AI agent failed for issue #$ISSUE_NUM"

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/ai-agent-${{ github.run_id }} || true
          echo "::notice::Cleanup complete"
