name: Test Workflows

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'scripts/test-workflows/**'
  workflow_dispatch:
    inputs:
      workflow_name:
        description: 'Specific workflow to test (leave empty for all)'
        required: false
        type: string
      event_type:
        description: 'Event type to simulate'
        required: false
        default: 'push'
        type: choice
        options:
          - push
          - pull_request
          - issue_comment
          - pull_request_review_comment

jobs:
  validate-workflows:
    runs-on: ubuntu-latest
    name: Validate Workflow Syntax
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate workflows
        run: pnpm test:workflows

  test-with-act:
    runs-on: ubuntu-latest
    name: Test with Act (Dry Run)
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup act
        run: |
          curl -sS https://raw.githubusercontent.com/nektos/act/master/install.sh -o /tmp/act_install.sh
          sudo bash /tmp/act_install.sh
          sudo mv ./bin/act /usr/local/bin/act || true
          which act && act --version || echo "act installed at $(find . -name act -type f 2>/dev/null)"

      - name: List available workflows
        run: |
          echo "ðŸ“‹ Available workflows:"
          ACT_CMD="$(which act 2>/dev/null || find $GITHUB_WORKSPACE -name act -type f 2>/dev/null | head -1)"
          echo "Using act at: $ACT_CMD"
          $ACT_CMD --list

      - name: Test specific workflow
        if: github.event.inputs.workflow_name != ''
        run: |
          echo "ðŸ§ª Testing workflow: ${{ github.event.inputs.workflow_name }}"
          ACT_CMD="$(which act 2>/dev/null || find $GITHUB_WORKSPACE -name act -type f 2>/dev/null | head -1)"
          $ACT_CMD -W .github/workflows/${{ github.event.inputs.workflow_name }} --dryrun --container-architecture linux/amd64

      - name: Test all workflows (dry run)
        if: github.event.inputs.workflow_name == ''
        run: |
          echo "ðŸ§ª Testing all workflows (dry run)..."
          ACT_CMD="$(which act 2>/dev/null || find $GITHUB_WORKSPACE -name act -type f 2>/dev/null | head -1)"
          for workflow in .github/workflows/*.yml; do
            if [ -f "$workflow" ]; then
              echo "Testing $(basename "$workflow")..."
              $ACT_CMD -W "$workflow" --dryrun --container-architecture linux/amd64 || echo "âš ï¸  $workflow had issues (may be expected for some workflows)"
            fi
          done

  test-matrix-workflow:
    runs-on: ubuntu-latest
    name: Test AI Agents Matrix Workflow
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, '.github/workflows/ai-agents-matrix.yml'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup act
        run: |
          curl -sS https://raw.githubusercontent.com/nektos/act/master/install.sh -o /tmp/act_install.sh
          sudo bash /tmp/act_install.sh
          sudo mv ./bin/act /usr/local/bin/act || true

      - name: Create test event
        run: |
          mkdir -p /tmp/test-events
          cat > /tmp/test-events/issue_comment.json << 'EOF'
          {
            "comment": {
              "body": "@claude test the matrix workflow",
              "user": {
                "login": "testuser"
              }
            },
            "issue": {
              "number": 123
            }
          }
          EOF

      - name: Test matrix workflow with @claude
        run: |
          echo "ðŸ¤– Testing AI Agents Matrix with @claude mention..."
          ACT_CMD="$(which act 2>/dev/null || find $GITHUB_WORKSPACE -name act -type f 2>/dev/null | head -1)"
          $ACT_CMD -W .github/workflows/ai-agents-matrix.yml -e /tmp/test-events/issue_comment.json --dryrun --container-architecture linux/amd64

      - name: Test matrix workflow with @codex
        run: |
          echo "ðŸ¤– Testing AI Agents Matrix with @codex mention..."
          ACT_CMD="$(which act 2>/dev/null || find $GITHUB_WORKSPACE -name act -type f 2>/dev/null | head -1)"
          echo '{"comment": {"body": "@codex test the matrix workflow"}, "issue": {"number": 123}}' > /tmp/test-events/codex_comment.json
          $ACT_CMD -W .github/workflows/ai-agents-matrix.yml -e /tmp/test-events/codex_comment.json --dryrun --container-architecture linux/amd64

      - name: Test matrix workflow with @gemini
        run: |
          echo "ðŸ¤– Testing AI Agents Matrix with @gemini mention..."
          ACT_CMD="$(which act 2>/dev/null || find $GITHUB_WORKSPACE -name act -type f 2>/dev/null | head -1)"
          echo '{"comment": {"body": "@gemini test the matrix workflow"}, "issue": {"number": 123}}' > /tmp/test-events/gemini_comment.json
          $ACT_CMD -W .github/workflows/ai-agents-matrix.yml -e /tmp/test-events/gemini_comment.json --dryrun --container-architecture linux/amd64
