name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    env:
      GITHUB_TOKEN: ${{ secrets.PAT_GITHUB }}

    steps:
      - name: Post initial review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GITHUB_TOKEN }}
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `ü§ñ Claude is reviewing this PR...\n\n[View workflow run](${runUrl})`
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ env.GITHUB_TOKEN }}

      - name: Setup Review Response Handler
        run: |
          # Create helper directory
          mkdir -p /tmp/claude

          # Create the review posting script
          cat > /tmp/claude/post-review.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          PR_NUMBER=$1
          OUTPUT_FILE=$2

          echo "Checking for Claude review file..."

          # First priority: Check if Claude created the expected review file
          if [ -f /tmp/claude_review.md ]; then
            echo "Found /tmp/claude_review.md - posting to PR"
            gh pr comment $PR_NUMBER --body-file /tmp/claude_review.md
            echo "SUCCESS: Posted Claude's review"
            exit 0
          fi

          # Second priority: Legacy review.md file
          if [ -f /tmp/review.md ]; then
            echo "Found /tmp/review.md - posting to PR"
            gh pr comment $PR_NUMBER --body-file /tmp/review.md
            echo "SUCCESS: Posted Claude's review"
            exit 0
          fi

          # Fallback: Extract Claude's text response
          echo "No review file found. Extracting Claude's text response..."

          if [ -f "$OUTPUT_FILE" ]; then
            CLAUDE_TEXT=$(jq -r '.result // empty' "$OUTPUT_FILE" 2>/dev/null || echo "")

            if [ -n "$CLAUDE_TEXT" ]; then
              echo "## ü§ñ Claude Code Review" > /tmp/fallback_review.md
              echo "" >> /tmp/fallback_review.md
              echo "$CLAUDE_TEXT" >> /tmp/fallback_review.md
              echo "" >> /tmp/fallback_review.md
              echo "---" >> /tmp/fallback_review.md
              echo "*ü§ñ Claude Code Bot ‚Ä¢ [View workflow](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)*" >> /tmp/fallback_review.md

              gh pr comment $PR_NUMBER --body-file /tmp/fallback_review.md
              echo "WARNING: Posted fallback review (Claude didn't create expected file)"
              exit 0
            fi
          fi

          # Last resort: Post an error message
          echo "## ü§ñ Claude Code Review - Error" > /tmp/error_review.md
          echo "" >> /tmp/error_review.md
          echo "I encountered an error while reviewing this PR." >> /tmp/error_review.md
          echo "" >> /tmp/error_review.md
          echo "Please check the [workflow logs](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID) for details." >> /tmp/error_review.md
          echo "" >> /tmp/error_review.md
          echo "---" >> /tmp/error_review.md
          echo "*ü§ñ Claude Code Bot*" >> /tmp/error_review.md

          gh pr comment $PR_NUMBER --body-file /tmp/error_review.md
          echo "ERROR: Posted error message (no review from Claude)"
          exit 1
          SCRIPT

          chmod +x /tmp/claude/post-review.sh

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_GITHUB }}
          GH_TOKEN: ${{ secrets.PAT_GITHUB }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.PAT_GITHUB }}
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }}.

            ## CRITICAL INSTRUCTION
            You MUST create a review file at `/tmp/claude_review.md` using the Write tool.
            This is NOT optional. The workflow will fail if you don't create this file.

            ## Review Guidelines
            1. Analyze the PR changes thoroughly using: gh pr diff ${{ github.event.pull_request.number }}
            2. Focus on:
               - Code quality and best practices
               - Potential bugs or issues
               - Performance implications
               - Security considerations
               - Test coverage
            3. Write your COMPLETE review to /tmp/claude_review.md

            ## Review File Structure
            Your review file MUST follow this structure:
            ```
            ## ü§ñ Claude Code Review

            ### Summary
            [Brief overview of the PR and your assessment]

            ### Code Quality
            [Comments on code quality, patterns, and practices]

            ### Potential Issues
            [Any bugs, security issues, or concerns]

            ### Suggestions
            [Specific improvements or recommendations]

            ### Verdict
            [Your recommendation: Approve / Request Changes / Comment]

            ---
            *ü§ñ Claude Code Bot ‚Ä¢ Automated PR Review ‚Ä¢ [View workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            ```

            Remember: You MUST use the Write tool to create /tmp/claude_review.md
            Do NOT attempt to post comments yourself - just create the file.
          claude_args: '--model claude-3-5-sonnet-20241022 --max-turns 20 --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(cat:*),Read,Write,MultiEdit,Glob,Grep"'

      - name: Post Claude Review
        if: always()
        run: |
          echo "Attempting to post Claude's review..."

          # The output file from Claude action
          OUTPUT_FILE="/home/runner/work/_temp/claude-execution-output.json"

          # Call our helper script
          /tmp/claude/post-review.sh ${{ github.event.pull_request.number }} "$OUTPUT_FILE"

          # Store the exit code
          EXIT_CODE=$?

          if [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Successfully posted Claude's review"
          else
            echo "‚ùå Failed to post Claude's review"
            exit 1
          fi

      - name: Verify Review Posted
        if: always()
        run: |
          # Wait for GitHub API to propagate the comment
          sleep 5

          # Check if review was posted
          RECENT_COMMENTS=$(gh pr view ${{ github.event.pull_request.number }} --json comments --jq '.comments[-1].body' 2>/dev/null || echo "")

          if echo "$RECENT_COMMENTS" | grep -q "Claude Code"; then
            echo "‚úÖ Verified: Claude Code review was posted"
          else
            echo "‚ö†Ô∏è  Warning: Could not verify Claude Code review"
          fi