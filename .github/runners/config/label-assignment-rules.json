{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "metadata": {
    "version": "1.0.0",
    "last_updated": "2025-10-17",
    "description": "Automated label assignment rules for GitHub Actions self-hosted runners",
    "wave": "Wave 2 - Infrastructure Provisioning",
    "managed_by": "DevOps Team"
  },
  "assignment_strategies": {
    "automatic": {
      "description": "Labels automatically assigned during runner provisioning",
      "trigger": "runner_registration",
      "editable": false
    },
    "manual": {
      "description": "Labels assigned by DevOps team based on runner purpose",
      "trigger": "devops_action",
      "editable": true
    },
    "dynamic": {
      "description": "Labels applied at workflow execution time based on job requirements",
      "trigger": "job_queue",
      "editable": false
    }
  },
  "label_categories": {
    "system_labels": {
      "assignment_strategy": "automatic",
      "required": true,
      "rules": [
        {
          "label": "self-hosted",
          "condition": "always",
          "value": "true",
          "description": "Identifies runner as self-hosted (GitHub requirement)",
          "applied_at": "registration"
        },
        {
          "label": "linux",
          "condition": "os_family == 'linux' || wsl_enabled == true",
          "value": "linux",
          "description": "Operating system family (WSL 2.0 on Windows)",
          "applied_at": "registration",
          "alternatives": ["windows", "macos"]
        },
        {
          "label": "x64",
          "condition": "architecture == 'x86_64' || architecture == 'amd64'",
          "value": "x64",
          "description": "Processor architecture",
          "applied_at": "registration",
          "alternatives": ["arm64", "arm32"]
        },
        {
          "label": "wsl-ubuntu-22.04",
          "condition": "wsl_distribution == 'Ubuntu-22.04'",
          "value": "wsl-ubuntu-22.04",
          "description": "WSL distribution and version",
          "applied_at": "registration"
        },
        {
          "label": "docker-capable",
          "condition": "command_exists('docker') && docker_version >= '20.10'",
          "value": "true",
          "description": "Docker Engine available in WSL",
          "applied_at": "registration",
          "optional": true
        },
        {
          "label": "ai-agent",
          "condition": "env_var_exists('OPENAI_API_KEY') || env_var_exists('ANTHROPIC_API_KEY')",
          "value": "true",
          "description": "LLM/AI capabilities configured",
          "applied_at": "registration",
          "optional": true
        },
        {
          "label": "gpu-available",
          "condition": "command_exists('nvidia-smi') && gpu_count > 0",
          "value": "true",
          "description": "GPU acceleration available",
          "applied_at": "registration",
          "optional": true
        },
        {
          "label": "high-memory",
          "condition": "total_memory_gb >= 16",
          "value": "true",
          "description": "High memory capacity (16+ GB)",
          "applied_at": "registration",
          "optional": true
        }
      ]
    },
    "resource_labels": {
      "assignment_strategy": "automatic",
      "required": true,
      "cardinality": "exactly_one",
      "rules": [
        {
          "label": "tier-basic",
          "condition": "cpu_cores == 2 && memory_gb == 4",
          "resource_spec": {
            "cpu": 2,
            "memory_gb": 4,
            "cost_monthly": 30
          },
          "description": "Basic tier - linting, scanning, quick tests",
          "use_cases": ["linting", "code-scanning", "quick-tests"]
        },
        {
          "label": "tier-standard",
          "condition": "cpu_cores >= 4 && cpu_cores <= 6 && memory_gb >= 8 && memory_gb <= 12",
          "resource_spec": {
            "cpu": "4-6",
            "memory_gb": "8-12",
            "cost_monthly": 60
          },
          "description": "Standard tier - unit tests, builds, integration tests (DEFAULT)",
          "use_cases": ["unit-tests", "builds", "integration-tests"],
          "default": true
        },
        {
          "label": "tier-performance",
          "condition": "cpu_cores == 8 && memory_gb == 16",
          "resource_spec": {
            "cpu": 8,
            "memory_gb": 16,
            "cost_monthly": 150
          },
          "description": "Performance tier - E2E tests, heavy builds",
          "use_cases": ["e2e-tests", "heavy-builds", "matrix-builds"]
        },
        {
          "label": "tier-compute-optimized",
          "condition": "cpu_cores >= 16 && memory_gb >= 32",
          "resource_spec": {
            "cpu": "16+",
            "memory_gb": "32+",
            "cost_monthly": 300
          },
          "description": "Compute tier - parallel builds, intensive CI",
          "use_cases": ["parallel-builds", "intensive-ci"]
        },
        {
          "label": "tier-memory-optimized",
          "condition": "memory_gb >= 32 && cpu_cores == 4",
          "resource_spec": {
            "cpu": 4,
            "memory_gb": "32+",
            "cost_monthly": 200
          },
          "description": "Memory tier - large datasets, memory analysis",
          "use_cases": ["large-datasets", "memory-analysis"]
        },
        {
          "label": "tier-io-optimized",
          "condition": "ssd_type == 'nvme' && storage_gb >= 500",
          "resource_spec": {
            "cpu": 4,
            "memory_gb": 16,
            "storage_gb": "500+",
            "cost_monthly": 180
          },
          "description": "I/O tier - database tests, artifact-heavy workflows",
          "use_cases": ["database-tests", "artifact-heavy"]
        }
      ]
    },
    "team_labels": {
      "assignment_strategy": "manual",
      "required": false,
      "cardinality": "zero_or_one",
      "rules": [
        {
          "label": "team-backend",
          "condition": "manual_assignment",
          "description": "Backend team dedicated runner",
          "repositories": ["api-server", "microservices", "database", "worker-queue"],
          "reserved_capacity": 1
        },
        {
          "label": "team-frontend",
          "condition": "manual_assignment",
          "description": "Frontend team dedicated runner",
          "repositories": ["web-app", "mobile-app", "ui-components"],
          "reserved_capacity": 1
        },
        {
          "label": "team-platform",
          "condition": "manual_assignment",
          "description": "Platform/Infrastructure team runner",
          "repositories": ["infra", "devops", "ci-cd-templates", "monitoring"],
          "reserved_capacity": 1
        },
        {
          "label": "team-data",
          "condition": "manual_assignment",
          "description": "Data engineering team runner",
          "repositories": ["analytics-pipeline", "ml-models", "data-export"],
          "reserved_capacity": 0.5
        },
        {
          "label": "team-ai-agents",
          "condition": "manual_assignment && ai-agent == true",
          "description": "AI agent team specialized runner",
          "repositories": ["pr-review-agent", "code-gen-agent", "testing-agent"],
          "reserved_capacity": 0.5,
          "requires": ["ai-agent"]
        }
      ]
    },
    "project_labels": {
      "assignment_strategy": "manual",
      "required": false,
      "cardinality": "zero_or_more",
      "rules": [
        {
          "label": "project-payments",
          "condition": "manual_assignment",
          "description": "Critical payment processing project",
          "priority": "critical",
          "reserved_capacity": 0.5,
          "sla_uptime": "99.95%"
        },
        {
          "label": "project-docs",
          "condition": "manual_assignment",
          "description": "Documentation generation project",
          "priority": "normal",
          "reserved_capacity": 0,
          "sla_uptime": "95%"
        }
      ]
    },
    "workflow_type_labels": {
      "assignment_strategy": "dynamic",
      "required": false,
      "cardinality": "zero_or_more",
      "description": "Applied by workflow definition, not stored on runner",
      "rules": [
        {
          "label": "workflow-pr-review",
          "condition": "workflow_file_contains('pr-review') || workflow_trigger == 'pull_request'",
          "description": "AI-powered pull request review",
          "requires": ["ai-agent"],
          "typical_duration_minutes": 5,
          "frequency_per_day": "50-100",
          "priority": "high"
        },
        {
          "label": "workflow-issue-triage",
          "condition": "workflow_trigger == 'issues'",
          "description": "Automated issue categorization",
          "requires": ["ai-agent"],
          "typical_duration_minutes": 2,
          "frequency_per_day": "20-40",
          "priority": "normal"
        },
        {
          "label": "workflow-code-quality",
          "condition": "workflow_file_contains('lint') || workflow_file_contains('format')",
          "description": "Linting, formatting, SAST",
          "requires": [],
          "typical_duration_minutes": 5,
          "frequency_per_day": "80-120",
          "priority": "high"
        },
        {
          "label": "workflow-unit-tests",
          "condition": "workflow_file_contains('test') || workflow_file_contains('jest|pytest|go test')",
          "description": "Unit test execution",
          "requires": [],
          "typical_duration_minutes": 15,
          "frequency_per_day": "60-100",
          "priority": "critical"
        },
        {
          "label": "workflow-integration-tests",
          "condition": "workflow_file_contains('integration') || workflow_file_contains('api-test')",
          "description": "Integration and API tests",
          "requires": ["docker-capable"],
          "typical_duration_minutes": 30,
          "frequency_per_day": "40-60",
          "priority": "high"
        },
        {
          "label": "workflow-build",
          "condition": "workflow_file_contains('build') || workflow_file_contains('compile')",
          "description": "Build and package artifacts",
          "requires": [],
          "typical_duration_minutes": 10,
          "frequency_per_day": "50-80",
          "priority": "critical"
        },
        {
          "label": "workflow-security-scan",
          "condition": "workflow_file_contains('security') || workflow_file_contains('vulnerability')",
          "description": "Security scanning and vulnerability detection",
          "requires": [],
          "typical_duration_minutes": 15,
          "frequency_per_day": "20-30",
          "priority": "critical"
        },
        {
          "label": "workflow-e2e-tests",
          "condition": "workflow_file_contains('e2e') || workflow_file_contains('playwright|cypress')",
          "description": "End-to-end UI testing",
          "requires": ["tier-performance"],
          "typical_duration_minutes": 60,
          "frequency_per_day": "10-20",
          "priority": "normal"
        },
        {
          "label": "workflow-deploy",
          "condition": "workflow_file_contains('deploy') && workflow_trigger == 'push'",
          "description": "Deployment workflows",
          "requires": ["tier-performance"],
          "typical_duration_minutes": 20,
          "frequency_per_day": "5-10",
          "priority": "critical"
        },
        {
          "label": "workflow-docs",
          "condition": "workflow_file_contains('docs') || workflow_path == 'docs/**'",
          "description": "Documentation generation",
          "requires": [],
          "typical_duration_minutes": 10,
          "frequency_per_day": "5-10",
          "priority": "low"
        }
      ]
    },
    "priority_labels": {
      "assignment_strategy": "dynamic",
      "required": false,
      "cardinality": "exactly_one",
      "default": "priority-normal",
      "rules": [
        {
          "label": "priority-critical",
          "condition": "workflow_contains('deploy') || workflow_contains('security') || repository == 'main-product'",
          "description": "Critical priority - jump to front of queue",
          "queue_position": 1,
          "sla_seconds": 30,
          "frequency_per_day": "<5"
        },
        {
          "label": "priority-high",
          "condition": "workflow_type in ['pr-review', 'unit-tests', 'code-quality']",
          "description": "High priority - after critical",
          "queue_position": 2,
          "sla_seconds": 120,
          "frequency_per_day": "50-100"
        },
        {
          "label": "priority-normal",
          "condition": "default",
          "description": "Normal priority - standard FIFO queue",
          "queue_position": 3,
          "sla_seconds": 300,
          "frequency_per_day": "100-200"
        }
      ]
    },
    "status_labels": {
      "assignment_strategy": "automatic",
      "required": true,
      "cardinality": "exactly_one",
      "description": "Operational state tracking",
      "rules": [
        {
          "label": "status-active",
          "condition": "heartbeat_success && uptime_seconds > 60",
          "description": "Runner is operational and accepting jobs",
          "monitoring_interval_seconds": 30
        },
        {
          "label": "status-draining",
          "condition": "maintenance_scheduled || scale_down_requested",
          "description": "Completing current jobs, not accepting new jobs",
          "behavior": "graceful_shutdown"
        },
        {
          "label": "status-offline",
          "condition": "heartbeat_failed >= 2 || runner_process_stopped",
          "description": "Runner not responsive",
          "action": "alert_devops"
        }
      ]
    }
  },
  "label_validation": {
    "enabled": true,
    "rules": [
      {
        "rule": "Must have exactly one resource tier label",
        "validation": "count(tier-*) == 1",
        "severity": "error"
      },
      {
        "rule": "Must have exactly one status label",
        "validation": "count(status-*) == 1",
        "severity": "error"
      },
      {
        "rule": "Can have at most one team label",
        "validation": "count(team-*) <= 1",
        "severity": "warning"
      },
      {
        "rule": "System labels must all be present",
        "validation": "has_label('self-hosted') && has_label('linux') && has_label('x64')",
        "severity": "error"
      },
      {
        "rule": "AI workflows require ai-agent label",
        "validation": "if workflow_type in ['pr-review', 'issue-triage'] then has_label('ai-agent')",
        "severity": "error"
      }
    ]
  },
  "label_routing_logic": {
    "description": "How workflows are routed to runners based on labels",
    "matching_algorithm": "exact_match_then_fallback",
    "steps": [
      {
        "step": 1,
        "action": "Match all required labels from runs-on",
        "example": "runs-on: [self-hosted, linux, ai-agent] requires runner with ALL these labels"
      },
      {
        "step": 2,
        "action": "If no exact match, try team-specific runner",
        "example": "If team-backend label requested, prefer backend runner group"
      },
      {
        "step": 3,
        "action": "Fall back to shared pool",
        "example": "If no team runner available, use shared-pool group"
      },
      {
        "step": 4,
        "action": "Queue if no capacity",
        "example": "Wait up to 10 minutes for runner availability"
      }
    ]
  },
  "automation_hooks": {
    "on_runner_registration": {
      "script": "scripts/auto-label-runner.sh",
      "actions": [
        "Detect OS and architecture",
        "Check Docker availability",
        "Detect LLM API keys",
        "Measure system resources",
        "Apply system and resource labels",
        "Register to appropriate runner group"
      ]
    },
    "on_workflow_queue": {
      "script": "scripts/route-workflow.sh",
      "actions": [
        "Parse runs-on labels",
        "Validate required capabilities",
        "Check runner group access",
        "Apply priority routing",
        "Queue or assign to runner"
      ]
    },
    "on_label_change": {
      "script": "scripts/sync-runner-labels.sh",
      "actions": [
        "Validate new labels",
        "Update runner registration",
        "Update runner group membership",
        "Log change to audit trail"
      ]
    }
  },
  "reporting": {
    "metrics": [
      {
        "metric": "label_usage_frequency",
        "description": "How often each label is requested in workflows",
        "collection_interval": "daily"
      },
      {
        "metric": "label_match_rate",
        "description": "Percentage of jobs that find matching runner",
        "collection_interval": "hourly",
        "target": ">95%"
      },
      {
        "metric": "fallback_rate",
        "description": "Percentage of jobs using shared pool fallback",
        "collection_interval": "daily",
        "target": "<30%"
      },
      {
        "metric": "queue_depth_by_label",
        "description": "Queue depth grouped by requested labels",
        "collection_interval": "real-time",
        "alert_threshold": ">10"
      }
    ]
  },
  "documentation_references": {
    "label_taxonomy": "docs/label-taxonomy.md",
    "runner_groups": "config/runner-groups.json",
    "management_guide": "docs/runner-group-management.md",
    "github_api": "https://docs.github.com/en/rest/actions/self-hosted-runners"
  }
}
