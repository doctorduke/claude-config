name: Test Secret Masking
description: Verify that secrets are properly masked in logs

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (with-masking or without-masking)'
        required: true
        default: 'with-masking'
        type: choice
        options:
          - with-masking
          - without-masking

permissions:
  contents: read

jobs:
  test-masking:
    name: Test Secret Masking
    runs-on: ubuntu-latest

    steps:
      # Test WITH masking (should show ***)
      - name: Mask secrets (conditional)
        if: inputs.test_mode == 'with-masking'
        uses: ./.github/actions/mask-secrets
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          ai_api_key: ${{ secrets.AI_API_KEY }}
          custom_secrets: test-secret-12345,another-secret-67890

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/

      - name: Test secret exposure scenarios
        env:
          TEST_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          echo "=== Testing Secret Masking ==="
          echo "Mode: ${{ inputs.test_mode }}"
          echo ""

          # Test 1: Direct echo (should be masked)
          echo "Test 1 - Direct echo of secrets:"
          echo "GitHub Token: $TEST_TOKEN"
          echo "API Key: $TEST_API_KEY"
          echo "Custom: test-secret-12345"
          echo "Custom: another-secret-67890"
          echo ""

          # Test 2: Error messages (common leak point)
          echo "Test 2 - Error messages:"
          set +e
          curl -H "Authorization: Bearer $TEST_TOKEN" https://api.example.com/fake 2>&1 || true
          echo ""

          # Test 3: Debug output (common leak point)
          echo "Test 3 - Debug output:"
          if [[ "${{ runner.debug }}" == "1" ]]; then
            echo "Debug: Token=$TEST_TOKEN"
          fi
          echo ""

          # Test 4: Variable expansion
          echo "Test 4 - Variable expansion:"
          VAR_WITH_SECRET="The token is: $TEST_TOKEN"
          echo "$VAR_WITH_SECRET"
          echo ""

          # Test 5: Command substitution
          echo "Test 5 - Command substitution:"
          echo "Token length: $(echo -n "$TEST_TOKEN" | wc -c)"
          echo ""

          # Test 6: File content
          echo "Test 6 - File operations:"
          echo "Token: $TEST_TOKEN" > /tmp/test-secret.txt
          cat /tmp/test-secret.txt
          rm -f /tmp/test-secret.txt
          echo ""

      - name: Test with verbose mode
        env:
          TEST_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Testing with verbose mode ==="

          # Common mistake: verbose mode can leak secrets
          set -x
          echo "This might leak: $TEST_TOKEN"
          set +x

          echo "‚úÖ Test complete"

      - name: Test API response logging
        env:
          TEST_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Testing API response logging ==="

          # Simulate API response that might contain token
          RESPONSE='{"token":"'$TEST_TOKEN'","status":"ok"}'
          echo "API Response: $RESPONSE"

          # Parse response (common leak point)
          echo "$RESPONSE" | grep -o '"token":"[^"]*"' || true

          echo "‚úÖ API test complete"

      - name: Summary
        run: |
          echo "## üìä Secret Masking Test Summary"
          echo ""
          echo "### Expected Results:"
          echo ""
          if [[ "${{ inputs.test_mode }}" == "with-masking" ]]; then
            echo "‚úÖ **WITH masking enabled:**"
            echo "- All secret values should appear as ***"
            echo "- No actual secret values should be visible"
            echo "- Test custom secrets should also be masked"
          else
            echo "‚ö†Ô∏è **WITHOUT masking (for comparison):**"
            echo "- Secret values may be visible (this is intentional for testing)"
            echo "- This mode demonstrates why masking is critical"
          fi
          echo ""
          echo "### Security Checks:"
          echo "- [ ] GitHub Token is masked"
          echo "- [ ] AI API Key is masked"
          echo "- [ ] Custom secrets are masked"
          echo "- [ ] Secrets in error messages are masked"
          echo "- [ ] Secrets in debug output are masked"
          echo "- [ ] Secrets in file content are masked"
          echo ""
          echo "### References:"
          echo "- OWASP A09:2021 - Security Logging and Monitoring Failures"
          echo "- CWE-532: Insertion of Sensitive Information into Log File"