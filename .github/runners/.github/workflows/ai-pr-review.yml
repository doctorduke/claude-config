name: AI PR Review
description: Automated PR code review using AI agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number
      ai_model:
        description: 'AI model to use for review'
        required: false
        type: choice
        options:
          - claude-3-opus
          - claude-3-sonnet
          - gpt-4
        default: 'claude-3-opus'

permissions:
  contents: read
  pull-requests: write
  issues: read

env:
  AI_MODEL: ${{ inputs.ai_model || 'claude-3-opus' }}
  MAX_FILES: 20
  REVIEW_TIMEOUT: 300

jobs:
  review:
    name: AI Code Review
    runs-on: [self-hosted, linux, ai-agent]
    timeout-minutes: 5

    steps:
      # SECURITY: Mask secrets as first step to prevent credential exposure
      # OWASP A09:2021 - Security Logging and Monitoring Failures
      - name: Mask sensitive values
        uses: ./.github/actions/mask-secrets
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          ai_api_key: ${{ secrets.AI_API_KEY }}

      - name: Validate PR number
        id: validate
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PR_NUM="${{ inputs.pr_number }}"
          else
            PR_NUM="${{ github.event.pull_request.number }}"
          fi

          if [[ ! "$PR_NUM" =~ ^[0-9]+$ ]]; then
            echo "::error::Invalid PR number: $PR_NUM"
            exit 1
          fi

          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "::notice::Validating PR #$PR_NUM for AI review"

      - name: Sparse checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            scripts/
            .github/
            src/
            tests/
          sparse-checkout-cone-mode: false

      - name: Checkout PR branch
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin pull/${{ steps.validate.outputs.pr_number }}/head:pr-${{ steps.validate.outputs.pr_number }}
          git checkout pr-${{ steps.validate.outputs.pr_number }}

      - name: Setup AI review environment
        id: setup
        run: |
          # Verify required tools
          command -v gh >/dev/null 2>&1 || { echo "::error::GitHub CLI not found"; exit 1; }
          command -v jq >/dev/null 2>&1 || { echo "::error::jq not found"; exit 1; }

          # Set up working directory
          mkdir -p /tmp/ai-review-${{ github.run_id }}
          echo "work_dir=/tmp/ai-review-${{ github.run_id }}" >> $GITHUB_OUTPUT

          # Configure GitHub CLI
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

          echo "::notice::Environment setup complete"

      - name: Run AI review script
        id: review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          PR_NUMBER: ${{ steps.validate.outputs.pr_number }}
          WORK_DIR: ${{ steps.setup.outputs.work_dir }}
        run: |
          set -euo pipefail

          # Run AI review script
          bash ./scripts/ai-review.sh \
            --pr "$PR_NUMBER" \
            --model "$AI_MODEL" \
            --max-files "$MAX_FILES" \
            --output "$WORK_DIR/review.json" \
            --verbose

          # Validate JSON output
          if [[ -f "$WORK_DIR/review.json" ]]; then
            jq empty "$WORK_DIR/review.json" || {
              echo "::error::Invalid JSON output from AI review"
              exit 1
            }
            echo "review_file=$WORK_DIR/review.json" >> $GITHUB_OUTPUT
            echo "::notice::AI review completed successfully"
          else
            echo "::error::Review output file not found"
            exit 1
          fi

      - name: Parse review results
        id: parse
        env:
          REVIEW_FILE: ${{ steps.review.outputs.review_file }}
        run: |
          # Extract review components
          REVIEW_BODY=$(jq -r '.review.body' "$REVIEW_FILE")
          REVIEW_EVENT=$(jq -r '.review.event' "$REVIEW_FILE")
          COMMENTS_COUNT=$(jq -r '.review.comments | length' "$REVIEW_FILE")

          echo "event=$REVIEW_EVENT" >> $GITHUB_OUTPUT
          echo "comments_count=$COMMENTS_COUNT" >> $GITHUB_OUTPUT

          # Save review body to file for gh CLI
          echo "$REVIEW_BODY" > "$REVIEW_FILE.body.md"
          echo "body_file=$REVIEW_FILE.body.md" >> $GITHUB_OUTPUT

          echo "::notice::Parsed review: event=$REVIEW_EVENT, comments=$COMMENTS_COUNT"

      - name: Post PR review
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.validate.outputs.pr_number }}
          BODY_FILE: ${{ steps.parse.outputs.body_file }}
          REVIEW_EVENT: ${{ steps.parse.outputs.event }}
        run: |
          set -euo pipefail

          # Map event type to gh CLI flag
          case "$REVIEW_EVENT" in
            "APPROVE")
              gh pr review "$PR_NUMBER" --approve --body-file "$BODY_FILE"
              ;;
            "REQUEST_CHANGES")
              gh pr review "$PR_NUMBER" --request-changes --body-file "$BODY_FILE"
              ;;
            "COMMENT"|*)
              gh pr review "$PR_NUMBER" --comment --body-file "$BODY_FILE"
              ;;
          esac

          echo "::notice::Posted $REVIEW_EVENT review on PR #$PR_NUMBER"

      - name: Post inline comments
        if: success() && steps.parse.outputs.comments_count > 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.validate.outputs.pr_number }}
          REVIEW_FILE: ${{ steps.review.outputs.review_file }}
        run: |
          # Extract and post individual comments
          COMMENTS=$(jq -c '.review.comments[]' "$REVIEW_FILE")

          while IFS= read -r comment; do
            FILE_PATH=$(echo "$comment" | jq -r '.path')
            LINE_NUM=$(echo "$comment" | jq -r '.line')
            COMMENT_BODY=$(echo "$comment" | jq -r '.body')

            # Post comment using gh API
            gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/comments \
              -f body="$COMMENT_BODY" \
              -f path="$FILE_PATH" \
              -F line=$LINE_NUM \
              -f side="RIGHT" || echo "::warning::Failed to post comment on $FILE_PATH:$LINE_NUM"
          done <<< "$COMMENTS"

          echo "::notice::Posted ${{ steps.parse.outputs.comments_count }} inline comments"

      - name: Handle review failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.validate.outputs.pr_number }}
        run: |
          # Post failure notification
          gh pr comment "$PR_NUMBER" --body "⚠️ **AI Review Failed**

          The automated AI review encountered an error. Please check the workflow logs for details.

          - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Triggered by: @${{ github.actor }}
          - Model: $AI_MODEL

          You may retry the review by re-running the workflow or triggering it manually."

          echo "::error::AI review failed - notification posted to PR #$PR_NUMBER"

      - name: Cleanup
        if: always()
        run: |
          # Clean up temporary files
          rm -rf /tmp/ai-review-${{ github.run_id }} || true
          echo "::notice::Cleanup complete"
