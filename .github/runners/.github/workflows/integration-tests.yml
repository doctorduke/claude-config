name: Integration Tests
description: Comprehensive integration testing for scripts and workflows

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

  push:
    branches:
      - main
      - develop
      - 'release/**'
      - 'testing/**'
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
      - 'scripts/tests/**'

  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
      - 'scripts/tests/**'

  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Specific test suite to run (leave empty for all)'
        required: false
        type: string
      parallel:
        description: 'Run tests in parallel'
        required: false
        type: boolean
        default: false
      fail_fast:
        description: 'Stop on first failure'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  pull-requests: write
  checks: write

env:
  TEST_TIMEOUT: 300
  CLEANUP_ON_SUCCESS: true
  PARALLEL_EXECUTION: ${{ inputs.parallel || 'false' }}
  FAIL_FAST: ${{ inputs.fail_fast || 'false' }}

jobs:
  setup:
    name: Test Setup
    runs-on: ubuntu-latest
    outputs:
      test_suites: ${{ steps.discover.outputs.test_suites }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Discover test suites
        id: discover
        run: |
          if [[ -n "${{ inputs.test_suite }}" ]]; then
            # Run specific test suite
            TEST_SUITES='["${{ inputs.test_suite }}"]'
          else
            # Discover all test suites
            cd scripts/tests/integration
            TEST_SUITES=$(ls test-*.sh | jq -R -s -c 'split("\n")[:-1]')
          fi

          echo "test_suites=$TEST_SUITES" >> $GITHUB_OUTPUT
          echo "Found test suites: $TEST_SUITES"

      - name: Validate test environment
        run: |
          # Check required tools
          command -v bash >/dev/null 2>&1 || { echo "bash not found"; exit 1; }
          command -v jq >/dev/null 2>&1 || { echo "jq not found"; exit 1; }
          command -v curl >/dev/null 2>&1 || { echo "curl not found"; exit 1; }

          echo "Test environment validated"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run test helper unit tests
        run: |
          cd scripts/tests
          bash -c "source lib/test-helpers.sh && log_info 'Test helpers loaded successfully'"

      - name: Validate test helpers
        run: |
          cd scripts/tests
          bash -c "
            source lib/test-helpers.sh

            # Test assertion functions
            assert_equals 'test' 'test' 'String equality'
            assert_contains 'hello world' 'world' 'String contains'
            assert_greater_than 10 5 'Greater than'

            echo 'All test helper validations passed'
          "

  integration-tests:
    name: Integration Test - ${{ matrix.suite }}
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.test_suites != '[]'

    strategy:
      fail-fast: false
      matrix:
        suite: ${{ fromJson(needs.setup.outputs.test_suites) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup test environment
        run: |
          # Create test directories
          mkdir -p /tmp/integration-test-reports

          # Install additional dependencies if needed
          sudo apt-get update -qq
          sudo apt-get install -y -qq shellcheck 2>/dev/null || true

          echo "Test environment ready"

      - name: Setup mock services
        run: |
          # Install Python for mock server
          sudo apt-get install -y -qq python3 python3-pip

          echo "Mock services ready"

      - name: Run integration test suite
        id: test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_SUITE: ${{ matrix.suite }}
        run: |
          cd scripts/tests/integration

          # Make test executable
          chmod +x "$TEST_SUITE"

          # Run test suite
          echo "Running: $TEST_SUITE"
          if bash "$TEST_SUITE"; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.suite }}
          path: /tmp/test-*
          retention-days: 7

      - name: Comment on PR (if test failed)
        if: failure() && github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## Integration Test Failure

          Test suite **${{ matrix.suite }}** failed.

          - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Branch: \`${{ github.head_ref }}\`

          Please review the test logs for details."

  full-suite:
    name: Full Integration Test Suite
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup test environment
        run: |
          mkdir -p /tmp/integration-test-reports

          # Install dependencies
          sudo apt-get update -qq
          sudo apt-get install -y -qq python3 shellcheck

          echo "Full test environment ready"

      - name: Run all integration tests
        id: all_tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PARALLEL_EXECUTION: ${{ env.PARALLEL_EXECUTION }}
          FAIL_FAST: ${{ env.FAIL_FAST }}
          TEST_TIMEOUT: ${{ env.TEST_TIMEOUT }}
        run: |
          cd scripts/tests/integration

          # Make all tests executable
          chmod +x *.sh

          # Run master test runner
          if bash run-all-tests.sh; then
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "pass_rate=100" >> $GITHUB_OUTPUT
          else
            # Extract pass rate from output
            PASS_RATE=$(grep -oP 'Overall Pass Rate: \K\d+' /tmp/integration-test-reports/*.log | head -1 || echo "0")
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT

            if [[ $PASS_RATE -ge 60 ]]; then
              echo "Acceptable pass rate: $PASS_RATE%"
              exit 0
            else
              echo "Unacceptable pass rate: $PASS_RATE%"
              exit 1
            fi
          fi

      - name: Generate test report
        if: always()
        run: |
          cd /tmp/integration-test-reports

          # Create summary
          cat > summary.md << 'EOF'
          # Integration Test Report

          ## Summary
          - Status: ${{ steps.all_tests.outputs.status }}
          - Pass Rate: ${{ steps.all_tests.outputs.pass_rate }}%
          - Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Test Suites
          EOF

          # Add test suite results
          for log in *.log; do
            if [[ -f "$log" ]]; then
              echo "### ${log%.log}" >> summary.md
              grep "Pass rate:" "$log" >> summary.md || echo "No results" >> summary.md
              echo "" >> summary.md
            fi
          done

          cat summary.md

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-reports
          path: /tmp/integration-test-reports/
          retention-days: 30

      - name: Publish test results
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Status: **${{ steps.all_tests.outputs.status }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Pass Rate: **${{ steps.all_tests.outputs.pass_rate }}%**" >> $GITHUB_STEP_SUMMARY
          echo "- Threshold: 60%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.all_tests.outputs.status }}" == "passed" ]]; then
            echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          elif [[ ${{ steps.all_tests.outputs.pass_rate }} -ge 60 ]]; then
            echo "⚠️ Some tests failed, but pass rate is acceptable" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests failed - pass rate below threshold" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup:
    name: Cleanup Test Data
    runs-on: ubuntu-latest
    needs: [integration-tests, full-suite]
    if: always()

    steps:
      - name: Cleanup test resources
        run: |
          echo "Cleaning up test data..."

          # Remove temporary files
          rm -rf /tmp/test-* /tmp/mock-* 2>/dev/null || true

          echo "Cleanup complete"

      - name: Report cleanup status
        run: |
          echo "Test cleanup completed successfully"
