name: AI Security Scan

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

env:
  SCAN_DEPENDENCIES: true
  SCAN_CODE: true
  SCAN_SECRETS: true
  FAIL_ON_HIGH_SEVERITY: true
  AI_ANALYSIS: true

jobs:
  security-scan:
    name: Security Scan
    runs-on: [self-hosted, linux, ai-agent]
    timeout-minutes: 20

    steps:
      - name: Setup AI Agent Environment
        uses: ./.github/actions/setup-ai-agent
        with:
          sparse-checkout: 'false'
          setup-node: 'true'

      - name: Dependency Scan
        if: env.SCAN_DEPENDENCIES == 'true'
        id: dep-scan
        run: |
          echo "ðŸ” Scanning dependencies..."

          # npm audit
          if [ -f "package.json" ]; then
            npm audit --json > npm-audit.json || true
            NPM_VULNS=$(jq '.metadata.vulnerabilities | .high + .critical' npm-audit.json)
            echo "npm_vulnerabilities=$NPM_VULNS" >> $GITHUB_OUTPUT
          fi

          # Python safety check
          if [ -f "requirements.txt" ]; then
            pip install safety
            safety check --json > python-safety.json || true
            PYTHON_VULNS=$(jq 'length' python-safety.json)
            echo "python_vulnerabilities=$PYTHON_VULNS" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Code Security Scan
        if: env.SCAN_CODE == 'true'
        id: code-scan
        run: |
          echo "ðŸ” Running SAST..."

          # Run security linters
          if [ -f "package.json" ]; then
            npx eslint-plugin-security . --format json > eslint-security.json || true
          fi

          # Semgrep scan
          docker run --rm -v "$(pwd):/src" returntocorp/semgrep semgrep \
            --config=auto --json > semgrep-results.json || true

          SAST_ISSUES=$(jq '.results | length' semgrep-results.json)
          echo "sast_issues=$SAST_ISSUES" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Secret Scan
        if: env.SCAN_SECRETS == 'true'
        id: secret-scan
        run: |
          echo "ðŸ” Scanning for secrets..."

          # Use gitleaks
          docker run --rm -v "$(pwd):/repo" zricethezav/gitleaks:latest \
            detect --source /repo --report-format json --report-path /repo/gitleaks-report.json || true

          if [ -f "gitleaks-report.json" ]; then
            SECRET_LEAKS=$(jq 'length' gitleaks-report.json)
            echo "secret_leaks=$SECRET_LEAKS" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: AI Security Analysis
        if: env.AI_ANALYSIS == 'true'
        id: ai-analysis
        run: |
          echo "ðŸ¤– AI security analysis..."

          # Aggregate all findings
          jq -n \
            --argjson npm "$(cat npm-audit.json 2>/dev/null || echo '{}')" \
            --argjson sast "$(cat semgrep-results.json 2>/dev/null || echo '{}')" \
            --argjson secrets "$(cat gitleaks-report.json 2>/dev/null || echo '[]')" \
            '{
              npm_audit: $npm,
              sast_results: $sast,
              secret_leaks: $secrets
            }' > security-findings.json

          # Call AI for risk assessment
          bash .github/scripts/ai-security-analyze.sh \
            --findings security-findings.json \
            --output ai-security-assessment.json
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
        continue-on-error: true

      - name: Generate Security Report
        run: |
          echo "ðŸ“Š Generating security report..."

          cat > security-report.md <<EOF
          ## ðŸ”’ Security Scan Results

          **Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### Dependency Vulnerabilities
          - **npm**: ${NPM_VULNS:-0} high/critical
          - **Python**: ${PYTHON_VULNS:-0} vulnerabilities

          ### Code Security Issues
          - **SAST**: ${SAST_ISSUES:-0} potential issues

          ### Secret Leaks
          - **Detected**: ${SECRET_LEAKS:-0} potential secrets

          $(if [ -f "ai-security-assessment.json" ]; then
            jq -r '.assessment' ai-security-assessment.json
          fi)

          ---
          *Generated by AI Security Scanner*
          EOF

      - name: Post Security Report
        if: github.event_name == 'pull_request'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$(cat security-report.md)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Fail on High Severity
        if: env.FAIL_ON_HIGH_SEVERITY == 'true'
        run: |
          TOTAL_HIGH=$((${NPM_VULNS:-0} + ${SECRET_LEAKS:-0}))

          if [ "$TOTAL_HIGH" -gt 0 ]; then
            echo "âŒ High severity issues found: $TOTAL_HIGH"
            exit 1
          fi
