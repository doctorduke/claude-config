name: AI Code Auto-Fix

on:
  pull_request:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to fix'
        required: true
        type: number
      fix_type:
        description: 'Type of fix'
        required: false
        default: 'lint'
        type: choice
        options:
          - lint
          - format
          - security
          - all

permissions:
  contents: write
  pull-requests: write

env:
  FIX_TYPES: lint,format
  RUN_TESTS_AFTER_FIX: true
  AI_MODEL: gpt-4
  AI_PROVIDER: openai

jobs:
  auto-fix:
    name: AI Code Auto-Fix
    runs-on: [self-hosted, linux, ai-agent]
    timeout-minutes: 20

    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.label.name, 'auto-fix')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/fix'))

    steps:
      - name: Get PR Number
        id: get-pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER="${{ inputs.pr_number }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ PR Number: $PR_NUMBER"

      - name: Get PR Branch
        id: pr-branch
        run: |
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"

          BRANCH=$(gh pr view "$PR_NUMBER" --json headRefName --jq '.headRefName')
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸŒ¿ Branch: $BRANCH"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup AI Agent Environment
        uses: ./.github/actions/setup-ai-agent
        with:
          sparse-checkout: 'false'  # Need full checkout for fixes
          ref: ${{ steps.pr-branch.outputs.branch }}
          setup-node: 'true'

      - name: Configure Git
        run: |
          git config user.name "AI Agent"
          git config user.email "ai-agent@github.com"

      - name: Run Code Analysis
        id: analysis
        run: |
          echo "ðŸ” Running code analysis..."

          FIX_TYPE="${{ inputs.fix_type || env.FIX_TYPES }}"

          # Run linters and analysis tools
          bash .github/scripts/analyze-code.sh --fix-type "$FIX_TYPE" > analysis-results.json

          ISSUES_FOUND=$(jq '.issues | length' analysis-results.json)
          echo "issues_found=$ISSUES_FOUND" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Found $ISSUES_FOUND issues"

          if [ "$ISSUES_FOUND" -eq 0 ]; then
            echo "âœ… No issues found - code is clean!"
            exit 0
          fi
        continue-on-error: true

      - name: Post No Issues Comment
        if: steps.analysis.outputs.issues_found == '0'
        run: |
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"

          gh pr comment "$PR_NUMBER" --body "## âœ… Code Analysis Complete

          No fixable issues were found in this PR. Your code looks good!

          **Checks performed:**
          - Linting
          - Code formatting
          - Security scanning

          *No changes needed.*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate AI Fixes
        if: steps.analysis.outputs.issues_found != '0'
        id: ai-fix
        run: |
          echo "ðŸ¤– Generating AI fixes..."

          bash .github/scripts/ai-generate-fixes.sh \
            --analysis-file analysis-results.json \
            --output-dir fix-patches/

          if [ -d "fix-patches" ] && [ "$(ls -A fix-patches)" ]; then
            FIXES_COUNT=$(ls fix-patches/*.patch 2>/dev/null | wc -l)
            echo "fixes_generated=$FIXES_COUNT" >> $GITHUB_OUTPUT
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            echo "âœ… Generated $FIXES_COUNT fixes"
          else
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No fixes could be generated"
          fi
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
        continue-on-error: true

      - name: Apply Fixes
        if: steps.ai-fix.outputs.has_fixes == 'true'
        id: apply-fixes
        run: |
          echo "ðŸ”§ Applying fixes..."

          bash .github/scripts/apply-fixes.sh fix-patches/

          # Check if any files were modified
          if git diff --quiet; then
            echo "applied=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No changes after applying fixes"
          else
            echo "applied=true" >> $GITHUB_OUTPUT
            CHANGED_FILES=$(git diff --name-only | wc -l)
            echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "âœ… Applied fixes to $CHANGED_FILES files"
          fi

      - name: Run Tests
        if: |
          steps.apply-fixes.outputs.applied == 'true' &&
          env.RUN_TESTS_AFTER_FIX == 'true'
        id: tests
        run: |
          echo "ðŸ§ª Running tests..."

          if [ -f "package.json" ] && jq -e '.scripts.test' package.json > /dev/null; then
            npm test
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          elif [ -f "pytest.ini" ] || [ -f "setup.py" ]; then
            pytest
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ No test command found"
          fi
        continue-on-error: true

      - name: Rollback on Test Failure
        if: steps.tests.outputs.tests_passed == 'false'
        run: |
          echo "âŒ Tests failed - rolling back changes..."
          git reset --hard HEAD
          exit 1

      - name: Commit and Push Fixes
        if: steps.apply-fixes.outputs.applied == 'true'
        id: commit
        run: |
          echo "ðŸ’¾ Committing fixes..."

          # Generate commit message
          jq -r '.fixes | map(.description) | join("\n- ")' fix-summary.json > fix-list.txt

          git add .
          git commit -m "chore: AI auto-fix

          Applied automated fixes:
          - $(cat fix-list.txt)

          Generated by AI Agent workflow
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Push changes
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            echo "ðŸ“¤ Push attempt $i..."

            if git push origin HEAD; then
              echo "âœ… Pushed successfully"
              echo "pushed=true" >> $GITHUB_OUTPUT
              break
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Push failed, rebasing..."
                git pull --rebase origin "${{ steps.pr-branch.outputs.branch }}"
              else
                echo "âŒ Push failed after $MAX_RETRIES attempts"
                echo "pushed=false" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.AI_AGENT_PAT || secrets.GITHUB_TOKEN }}

      - name: Post Fix Summary
        if: steps.apply-fixes.outputs.applied == 'true'
        run: |
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"

          cat > fix-comment.md <<EOF
          ## ðŸ”§ AI Auto-Fix Applied

          **Summary:**
          - Fixed ${{ steps.analysis.outputs.issues_found }} issues
          - Modified ${{ steps.apply-fixes.outputs.changed_files }} files
          - Tests: ${{ steps.tests.outputs.tests_passed == 'true' && 'âœ… Passed' || 'âš ï¸ Not run' }}

          **Changes:**
          $(jq -r '.fixes | map("- **" + .file + "**: " + .description) | join("\n")' fix-summary.json)

          **Next Steps:**
          - Review the automated changes
          - Verify the fixes resolve the issues
          - Approve and merge if satisfied

          ---
          *Generated by AI Agent â€¢ [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          EOF

          gh pr comment "$PR_NUMBER" --body "$(cat fix-comment.md)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Labels
        if: steps.apply-fixes.outputs.applied == 'true'
        run: |
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"

          # Remove auto-fix label
          gh pr edit "$PR_NUMBER" --remove-label "auto-fix" || true

          # Add ai-fixed label
          gh pr edit "$PR_NUMBER" --add-label "ai-fixed"

          echo "ðŸ·ï¸ Labels updated"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Handle Failure
        if: failure()
        run: |
          PR_NUMBER="${{ steps.get-pr.outputs.pr_number }}"

          gh pr comment "$PR_NUMBER" --body "## âŒ Auto-Fix Failed

          The automated fix process encountered an error.

          **Possible causes:**
          - Fixes could not be generated
          - Tests failed after applying fixes
          - Push conflicts with protected branch

          **Next Steps:**
          - Review workflow logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Manual fixes may be required"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
